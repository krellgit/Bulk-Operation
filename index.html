<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Ads Bulk Sheet Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #232f3e;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #232f3e;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #ff9900;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: #ff9900;
            background: #fff8eb;
        }

        .upload-zone.dragover {
            border-color: #ff9900;
            background: #fff8eb;
        }

        .upload-zone input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .file-info {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            display: none;
            margin-top: 15px;
        }

        .file-info.show {
            display: block;
        }

        .file-info .filename {
            font-weight: bold;
            color: #2e7d32;
        }

        .file-info .details {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .match-type-section {
            display: none;
        }

        .match-type-section.show {
            display: block;
        }

        .match-type-table {
            width: 100%;
            border-collapse: collapse;
        }

        .match-type-table th,
        .match-type-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .match-type-table th {
            background: #f5f7fa;
            font-weight: 600;
            color: #232f3e;
        }

        .match-type-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .match-type-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .na-cell {
            color: #999;
            font-style: italic;
        }

        .btn {
            background: #ff9900;
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #e68a00;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-container {
            text-align: center;
            margin-top: 30px;
        }

        .output-section {
            display: none;
        }

        .output-section.show {
            display: block;
        }

        .success-message {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .success-message h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: #f5f7fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #232f3e;
        }

        .stat-box .label {
            font-size: 0.85rem;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            color: #c62828;
            margin-top: 15px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .template-link {
            text-align: center;
            margin-top: 15px;
        }

        .template-link a {
            color: #0066c0;
            text-decoration: none;
        }

        .template-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Amazon Ads Bulk Sheet Generator</h1>
        <p class="subtitle">Generate Sponsored Products bulk upload sheets from your product and keyword data</p>

        <!-- Step 1: Upload -->
        <div class="card">
            <h2><span class="step-number">1</span> Upload Input File</h2>
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <p><strong>Click to upload</strong> or drag and drop</p>
                <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">Excel file (.xlsx) with Products and Keywords tabs</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
            <div class="file-info" id="fileInfo">
                <span class="filename" id="fileName"></span>
                <div class="details" id="fileDetails"></div>
            </div>
            <div class="error-message" id="uploadError"></div>
            <div class="template-link">
                <a href="#" id="downloadTemplate">Download input template</a>
            </div>
        </div>

        <!-- Step 2: Match Type Selection -->
        <div class="card match-type-section" id="matchTypeSection">
            <h2><span class="step-number">2</span> Select Match Types</h2>
            <p style="color: #666; margin-bottom: 20px;">Choose which match types to generate for each keyword campaign:</p>
            <table class="match-type-table">
                <thead>
                    <tr>
                        <th>Campaign Type</th>
                        <th>Exact</th>
                        <th>Phrase</th>
                        <th>Broad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Branded Keywords</td>
                        <td><input type="checkbox" id="branded_kw_exact" checked></td>
                        <td><input type="checkbox" id="branded_kw_phrase" checked></td>
                        <td><input type="checkbox" id="branded_kw_broad"></td>
                    </tr>
                    <tr>
                        <td>Branded ASINs</td>
                        <td class="na-cell">N/A</td>
                        <td class="na-cell">N/A</td>
                        <td class="na-cell">N/A</td>
                    </tr>
                    <tr>
                        <td>Competitor Keywords</td>
                        <td><input type="checkbox" id="competitor_kw_exact" checked></td>
                        <td><input type="checkbox" id="competitor_kw_phrase" checked></td>
                        <td><input type="checkbox" id="competitor_kw_broad"></td>
                    </tr>
                    <tr>
                        <td>Competitor ASINs</td>
                        <td class="na-cell">N/A</td>
                        <td class="na-cell">N/A</td>
                        <td class="na-cell">N/A</td>
                    </tr>
                    <tr>
                        <td>Unbranded Keywords</td>
                        <td><input type="checkbox" id="unbranded_kw_exact" checked></td>
                        <td><input type="checkbox" id="unbranded_kw_phrase" checked></td>
                        <td><input type="checkbox" id="unbranded_kw_broad"></td>
                    </tr>
                </tbody>
            </table>

            <div class="btn-container">
                <button class="btn" id="generateBtn">
                    <span>‚ö°</span> Generate Bulk Sheet
                </button>
            </div>
        </div>

        <!-- Step 3: Output -->
        <div class="card output-section" id="outputSection">
            <h2><span class="step-number">3</span> Download Output</h2>
            <div class="success-message">
                <h3>‚úì Bulk Sheet Generated Successfully!</h3>
                <div class="stats" id="stats">
                    <div class="stat-box">
                        <div class="number" id="statCampaigns">0</div>
                        <div class="label">Campaigns</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statAdGroups">0</div>
                        <div class="label">Ad Groups</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statAds">0</div>
                        <div class="label">Product Ads</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statKeywords">0</div>
                        <div class="label">Keywords/Targets</div>
                    </div>
                </div>
                <button class="btn" id="downloadBtn">
                    <span>üì•</span> Download CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let parsedData = {
            products: [],
            keywords: {
                brandedKeywords: [],
                brandedAsins: [],
                competitorKeywords: [],
                competitorAsins: [],
                unbranded: [],
                auto: []
            }
        };
        let generatedCSV = '';
        let stats = { campaigns: 0, adGroups: 0, ads: 0, keywords: 0 };

        // DOM Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileDetails = document.getElementById('fileDetails');
        const uploadError = document.getElementById('uploadError');
        const matchTypeSection = document.getElementById('matchTypeSection');
        const generateBtn = document.getElementById('generateBtn');
        const outputSection = document.getElementById('outputSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadTemplate = document.getElementById('downloadTemplate');

        // Budget distribution percentages
        const BUDGET_DISTRIBUTION = {
            branded: 0.05,      // 5%
            competitor: 0.20,   // 20%
            unbranded: 0.75    // 75%
        };

        const DEFAULT_BID = 0.69;
        const MIN_BUDGET = 10;

        // CSV Headers (Amazon Bulk Sheet format)
        const CSV_HEADERS = [
            'Product', 'Entity', 'Operation', 'Campaign ID', 'Ad Group ID', 'Portfolio ID',
            'Ad ID', 'Keyword ID', 'Product Targeting ID', 'Campaign Name', 'Ad Group Name',
            'Start Date', 'End Date', 'Targeting Type', 'State', 'Daily Budget', 'SKU',
            'Ad Group Default Bid', 'Bid', 'Keyword Text', 'Native Language Keyword',
            'Native Language Locale', 'Match Type', 'Bidding Strategy', 'Placement',
            'Percentage', 'Product Targeting Expression'
        ];

        // Event Listeners
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
        generateBtn.addEventListener('click', generateBulkSheet);
        downloadBtn.addEventListener('click', downloadCSV);
        downloadTemplate.addEventListener('click', (e) => {
            e.preventDefault();
            generateTemplate();
        });

        // Handle file upload
        function handleFile(file) {
            if (!file.name.match(/\.xlsx?$/i)) {
                showError('Please upload an Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Parse the workbook
                    parseWorkbook(workbook);

                    // Show success
                    fileName.textContent = file.name;
                    fileDetails.textContent = `${parsedData.products.length} products, ${countKeywords()} keywords/ASINs`;
                    fileInfo.classList.add('show');
                    uploadError.classList.remove('show');
                    matchTypeSection.classList.add('show');
                    outputSection.classList.remove('show');

                } catch (err) {
                    showError('Error parsing file: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse workbook
        function parseWorkbook(workbook) {
            const sheetNames = workbook.SheetNames;

            // Find Products tab (Tab 1)
            const productsSheet = workbook.Sheets[sheetNames[0]];
            const productsData = XLSX.utils.sheet_to_json(productsSheet, { defval: '' });

            parsedData.products = productsData.map(row => ({
                sku: String(row['SKU'] || row['sku'] || '').trim(),
                asin: String(row['ASIN'] || row['asin'] || '').trim(),
                budget: parseFloat(row['Budget'] || row['budget'] || MIN_BUDGET) || MIN_BUDGET
            })).filter(p => p.sku && p.asin);

            // Validate minimum budget
            parsedData.products.forEach(p => {
                if (p.budget < MIN_BUDGET) p.budget = MIN_BUDGET;
            });

            // Find Keywords tab (Tab 2)
            if (sheetNames.length > 1) {
                const keywordsSheet = workbook.Sheets[sheetNames[1]];
                const keywordsData = XLSX.utils.sheet_to_json(keywordsSheet, { defval: '' });

                // Reset keywords
                parsedData.keywords = {
                    brandedKeywords: [],
                    brandedAsins: [],
                    competitorKeywords: [],
                    competitorAsins: [],
                    unbranded: [],
                    auto: []
                };

                // Extract columns
                keywordsData.forEach(row => {
                    const brandedKw = String(row['Branded Keywords'] || row['branded keywords'] || '').trim();
                    const brandedAsin = String(row['Branded ASINs'] || row['branded asins'] || row['Branded ASIN'] || '').trim();
                    const compKw = String(row['Competitor Keywords'] || row['competitor keywords'] || '').trim();
                    const compAsin = String(row['Competitor ASINs'] || row['competitor asins'] || row['Competitor ASIN'] || '').trim();
                    const unbrandedKw = String(row['Unbranded'] || row['unbranded'] || row['Unbranded Keywords'] || '').trim();
                    const auto = String(row['Auto'] || row['auto'] || '').trim();

                    if (brandedKw) parsedData.keywords.brandedKeywords.push(brandedKw);
                    if (brandedAsin) parsedData.keywords.brandedAsins.push(brandedAsin);
                    if (compKw) parsedData.keywords.competitorKeywords.push(compKw);
                    if (compAsin) parsedData.keywords.competitorAsins.push(compAsin);
                    if (unbrandedKw) parsedData.keywords.unbranded.push(unbrandedKw);
                    if (auto) parsedData.keywords.auto.push(auto);
                });
            }
        }

        // Count total keywords
        function countKeywords() {
            const kw = parsedData.keywords;
            return kw.brandedKeywords.length + kw.brandedAsins.length +
                   kw.competitorKeywords.length + kw.competitorAsins.length +
                   kw.unbranded.length + kw.auto.length;
        }

        // Show error message
        function showError(message) {
            uploadError.textContent = message;
            uploadError.classList.add('show');
            fileInfo.classList.remove('show');
            matchTypeSection.classList.remove('show');
        }

        // Get selected match types
        function getSelectedMatchTypes() {
            return {
                brandedKeywords: {
                    exact: document.getElementById('branded_kw_exact').checked,
                    phrase: document.getElementById('branded_kw_phrase').checked,
                    broad: document.getElementById('branded_kw_broad').checked
                },
                competitorKeywords: {
                    exact: document.getElementById('competitor_kw_exact').checked,
                    phrase: document.getElementById('competitor_kw_phrase').checked,
                    broad: document.getElementById('competitor_kw_broad').checked
                },
                unbranded: {
                    exact: document.getElementById('unbranded_kw_exact').checked,
                    phrase: document.getElementById('unbranded_kw_phrase').checked,
                    broad: document.getElementById('unbranded_kw_broad').checked
                }
            };
        }

        // Generate bulk sheet
        function generateBulkSheet() {
            const matchTypes = getSelectedMatchTypes();
            const rows = [];
            stats = { campaigns: 0, adGroups: 0, ads: 0, keywords: 0 };

            // Add header row
            rows.push(CSV_HEADERS);

            // Add empty rows (Amazon format starts with some empty rows)
            rows.push(new Array(CSV_HEADERS.length).fill(''));

            // Process each product/SKU
            parsedData.products.forEach(product => {
                const { sku, asin, budget } = product;

                // Calculate budget per segment
                const brandedBudget = budget * BUDGET_DISTRIBUTION.branded;
                const competitorBudget = budget * BUDGET_DISTRIBUTION.competitor;
                const unbrandedBudget = budget * BUDGET_DISTRIBUTION.unbranded;

                // Count campaigns in each segment for budget splitting
                const brandedCampaigns = countCampaignsInSegment('branded', matchTypes);
                const competitorCampaigns = countCampaignsInSegment('competitor', matchTypes);
                const unbrandedCampaigns = countCampaignsInSegment('unbranded', matchTypes);

                // Generate Branded Keywords campaigns
                if (parsedData.keywords.brandedKeywords.length > 0) {
                    const perCampaignBudget = brandedCampaigns > 0 ? brandedBudget / brandedCampaigns : 0;
                    ['exact', 'phrase', 'broad'].forEach(matchType => {
                        if (matchTypes.brandedKeywords[matchType]) {
                            const campaignRows = generateKeywordCampaign(
                                sku, asin, 'BrandedKeywords', matchType,
                                parsedData.keywords.brandedKeywords,
                                Math.max(1, Math.round(perCampaignBudget))
                            );
                            rows.push(...campaignRows);
                        }
                    });
                }

                // Generate Branded ASINs campaign
                if (parsedData.keywords.brandedAsins.length > 0) {
                    const perCampaignBudget = brandedCampaigns > 0 ? brandedBudget / brandedCampaigns : 0;
                    const campaignRows = generateAsinCampaign(
                        sku, asin, 'BrandedASINs',
                        parsedData.keywords.brandedAsins,
                        Math.max(1, Math.round(perCampaignBudget))
                    );
                    rows.push(...campaignRows);
                }

                // Generate Competitor Keywords campaigns
                if (parsedData.keywords.competitorKeywords.length > 0) {
                    const perCampaignBudget = competitorCampaigns > 0 ? competitorBudget / competitorCampaigns : 0;
                    ['exact', 'phrase', 'broad'].forEach(matchType => {
                        if (matchTypes.competitorKeywords[matchType]) {
                            const campaignRows = generateKeywordCampaign(
                                sku, asin, 'CompetitorKeywords', matchType,
                                parsedData.keywords.competitorKeywords,
                                Math.max(1, Math.round(perCampaignBudget))
                            );
                            rows.push(...campaignRows);
                        }
                    });
                }

                // Generate Competitor ASINs campaign
                if (parsedData.keywords.competitorAsins.length > 0) {
                    const perCampaignBudget = competitorCampaigns > 0 ? competitorBudget / competitorCampaigns : 0;
                    const campaignRows = generateAsinCampaign(
                        sku, asin, 'CompetitorASINs',
                        parsedData.keywords.competitorAsins,
                        Math.max(1, Math.round(perCampaignBudget))
                    );
                    rows.push(...campaignRows);
                }

                // Generate Unbranded Keywords campaigns
                if (parsedData.keywords.unbranded.length > 0) {
                    const perCampaignBudget = unbrandedCampaigns > 0 ? unbrandedBudget / unbrandedCampaigns : 0;
                    ['exact', 'phrase', 'broad'].forEach(matchType => {
                        if (matchTypes.unbranded[matchType]) {
                            const campaignRows = generateKeywordCampaign(
                                sku, asin, 'Unbranded', matchType,
                                parsedData.keywords.unbranded,
                                Math.max(1, Math.round(perCampaignBudget))
                            );
                            rows.push(...campaignRows);
                        }
                    });
                }

                // Generate Auto campaigns
                if (parsedData.keywords.auto.length > 0) {
                    const perCampaignBudget = unbrandedCampaigns > 0 ? unbrandedBudget / unbrandedCampaigns : 0;
                    parsedData.keywords.auto.forEach(autoType => {
                        const normalizedType = normalizeAutoType(autoType);
                        if (normalizedType) {
                            const campaignRows = generateAutoCampaign(
                                sku, asin, normalizedType,
                                Math.max(1, Math.round(perCampaignBudget))
                            );
                            rows.push(...campaignRows);
                        }
                    });
                }

                // Add empty row between products
                rows.push(new Array(CSV_HEADERS.length).fill(''));
            });

            // Convert to CSV
            generatedCSV = rows.map(row => row.map(cell => escapeCSV(cell)).join(',')).join('\n');

            // Update stats display
            document.getElementById('statCampaigns').textContent = stats.campaigns;
            document.getElementById('statAdGroups').textContent = stats.adGroups;
            document.getElementById('statAds').textContent = stats.ads;
            document.getElementById('statKeywords').textContent = stats.keywords;

            // Show output section
            outputSection.classList.add('show');
        }

        // Count campaigns in segment for budget calculation
        function countCampaignsInSegment(segment, matchTypes) {
            let count = 0;

            if (segment === 'branded') {
                if (parsedData.keywords.brandedKeywords.length > 0) {
                    if (matchTypes.brandedKeywords.exact) count++;
                    if (matchTypes.brandedKeywords.phrase) count++;
                    if (matchTypes.brandedKeywords.broad) count++;
                }
                if (parsedData.keywords.brandedAsins.length > 0) count++;
            }

            if (segment === 'competitor') {
                if (parsedData.keywords.competitorKeywords.length > 0) {
                    if (matchTypes.competitorKeywords.exact) count++;
                    if (matchTypes.competitorKeywords.phrase) count++;
                    if (matchTypes.competitorKeywords.broad) count++;
                }
                if (parsedData.keywords.competitorAsins.length > 0) count++;
            }

            if (segment === 'unbranded') {
                if (parsedData.keywords.unbranded.length > 0) {
                    if (matchTypes.unbranded.exact) count++;
                    if (matchTypes.unbranded.phrase) count++;
                    if (matchTypes.unbranded.broad) count++;
                }
                count += parsedData.keywords.auto.length;
            }

            return count;
        }

        // Normalize auto targeting type
        function normalizeAutoType(autoType) {
            const normalized = autoType.toLowerCase().replace(/\s+/g, '');
            if (normalized.includes('close')) return 'AutoCloseMatch';
            if (normalized.includes('loose')) return 'AutoLooseMatch';
            if (normalized.includes('complement')) return 'AutoComplements';
            if (normalized.includes('substitute')) return 'AutoSubstitutes';
            return null;
        }

        // Generate campaign name
        function getCampaignName(sku, segment, matchType = null) {
            if (matchType) {
                const matchTypeCapitalized = matchType.charAt(0).toUpperCase() + matchType.slice(1);
                return `${sku} [SP_${segment}_${matchTypeCapitalized}] JN`;
            }
            return `${sku} [SP_${segment}] JN`;
        }

        // Create empty row template
        function createEmptyRow() {
            return new Array(CSV_HEADERS.length).fill('');
        }

        // Generate keyword campaign rows
        function generateKeywordCampaign(sku, productAsin, segment, matchType, keywords, budget) {
            const rows = [];
            const campaignName = getCampaignName(sku, segment, matchType);
            const adGroupName = campaignName;
            const matchTypeCapitalized = matchType.charAt(0).toUpperCase() + matchType.slice(1);

            // Campaign row
            const campaignRow = createEmptyRow();
            campaignRow[0] = 'Sponsored Products';  // Product
            campaignRow[1] = 'Campaign';            // Entity
            campaignRow[2] = 'Create';              // Operation
            campaignRow[9] = campaignName;          // Campaign Name
            campaignRow[13] = 'Manual';             // Targeting Type
            campaignRow[14] = 'Enabled';            // State
            campaignRow[15] = budget;               // Daily Budget
            campaignRow[23] = 'Fixed Bid';          // Bidding Strategy
            rows.push(campaignRow);
            stats.campaigns++;

            // Ad Group row
            const adGroupRow = createEmptyRow();
            adGroupRow[0] = 'Sponsored Products';
            adGroupRow[1] = 'Ad Group';
            adGroupRow[2] = 'Create';
            adGroupRow[9] = campaignName;
            adGroupRow[10] = adGroupName;           // Ad Group Name
            adGroupRow[14] = 'Enabled';
            adGroupRow[17] = DEFAULT_BID;           // Ad Group Default Bid
            rows.push(adGroupRow);
            stats.adGroups++;

            // Product Ad row
            const productAdRow = createEmptyRow();
            productAdRow[0] = 'Sponsored Products';
            productAdRow[1] = 'Product Ad';
            productAdRow[2] = 'Create';
            productAdRow[9] = campaignName;
            productAdRow[10] = adGroupName;
            productAdRow[14] = 'Enabled';
            productAdRow[16] = sku;                 // SKU
            rows.push(productAdRow);
            stats.ads++;

            // Keyword rows
            keywords.forEach(keyword => {
                const keywordRow = createEmptyRow();
                keywordRow[0] = 'Sponsored Products';
                keywordRow[1] = 'Keyword';
                keywordRow[2] = 'Create';
                keywordRow[9] = campaignName;
                keywordRow[10] = adGroupName;
                keywordRow[14] = 'Enabled';
                keywordRow[18] = DEFAULT_BID;       // Bid
                keywordRow[19] = keyword;           // Keyword Text
                keywordRow[22] = matchTypeCapitalized; // Match Type
                rows.push(keywordRow);
                stats.keywords++;
            });

            return rows;
        }

        // Generate ASIN targeting campaign rows
        function generateAsinCampaign(sku, productAsin, segment, targetAsins, budget) {
            const rows = [];
            const campaignName = getCampaignName(sku, segment);
            const adGroupName = campaignName;

            // Campaign row
            const campaignRow = createEmptyRow();
            campaignRow[0] = 'Sponsored Products';
            campaignRow[1] = 'Campaign';
            campaignRow[2] = 'Create';
            campaignRow[9] = campaignName;
            campaignRow[13] = 'Manual';
            campaignRow[14] = 'Enabled';
            campaignRow[15] = budget;
            campaignRow[23] = 'Fixed Bid';
            rows.push(campaignRow);
            stats.campaigns++;

            // Ad Group row
            const adGroupRow = createEmptyRow();
            adGroupRow[0] = 'Sponsored Products';
            adGroupRow[1] = 'Ad Group';
            adGroupRow[2] = 'Create';
            adGroupRow[9] = campaignName;
            adGroupRow[10] = adGroupName;
            adGroupRow[14] = 'Enabled';
            adGroupRow[17] = DEFAULT_BID;
            rows.push(adGroupRow);
            stats.adGroups++;

            // Product Ad row
            const productAdRow = createEmptyRow();
            productAdRow[0] = 'Sponsored Products';
            productAdRow[1] = 'Product Ad';
            productAdRow[2] = 'Create';
            productAdRow[9] = campaignName;
            productAdRow[10] = adGroupName;
            productAdRow[14] = 'Enabled';
            productAdRow[16] = sku;
            rows.push(productAdRow);
            stats.ads++;

            // Product Targeting rows
            targetAsins.forEach(targetAsin => {
                const targetRow = createEmptyRow();
                targetRow[0] = 'Sponsored Products';
                targetRow[1] = 'Product Targeting';
                targetRow[2] = 'Create';
                targetRow[9] = campaignName;
                targetRow[10] = adGroupName;
                targetRow[14] = 'Enabled';
                targetRow[18] = DEFAULT_BID;
                targetRow[26] = `asin="${targetAsin}"`; // Product Targeting Expression
                rows.push(targetRow);
                stats.keywords++;
            });

            return rows;
        }

        // Generate Auto campaign rows
        function generateAutoCampaign(sku, productAsin, autoType, budget) {
            const rows = [];
            const campaignName = getCampaignName(sku, autoType);
            const adGroupName = campaignName;

            // Map auto type to targeting expression
            const autoTargetingMap = {
                'AutoCloseMatch': 'close-match',
                'AutoLooseMatch': 'loose-match',
                'AutoComplements': 'complements',
                'AutoSubstitutes': 'substitutes'
            };

            // Campaign row
            const campaignRow = createEmptyRow();
            campaignRow[0] = 'Sponsored Products';
            campaignRow[1] = 'Campaign';
            campaignRow[2] = 'Create';
            campaignRow[9] = campaignName;
            campaignRow[13] = 'Auto';
            campaignRow[14] = 'Enabled';
            campaignRow[15] = budget;
            campaignRow[23] = 'Fixed Bid';
            rows.push(campaignRow);
            stats.campaigns++;

            // Ad Group row
            const adGroupRow = createEmptyRow();
            adGroupRow[0] = 'Sponsored Products';
            adGroupRow[1] = 'Ad Group';
            adGroupRow[2] = 'Create';
            adGroupRow[9] = campaignName;
            adGroupRow[10] = adGroupName;
            adGroupRow[14] = 'Enabled';
            adGroupRow[17] = DEFAULT_BID;
            rows.push(adGroupRow);
            stats.adGroups++;

            // Product Ad row
            const productAdRow = createEmptyRow();
            productAdRow[0] = 'Sponsored Products';
            productAdRow[1] = 'Product Ad';
            productAdRow[2] = 'Create';
            productAdRow[9] = campaignName;
            productAdRow[10] = adGroupName;
            productAdRow[14] = 'Enabled';
            productAdRow[16] = sku;
            rows.push(productAdRow);
            stats.ads++;

            // Auto targeting row (to enable specific auto targeting type)
            const targetRow = createEmptyRow();
            targetRow[0] = 'Sponsored Products';
            targetRow[1] = 'Product Targeting';
            targetRow[2] = 'Create';
            targetRow[9] = campaignName;
            targetRow[10] = adGroupName;
            targetRow[14] = 'Enabled';
            targetRow[18] = DEFAULT_BID;
            targetRow[26] = `queryHighRelMatches="${autoTargetingMap[autoType]}"`; // Auto targeting expression
            rows.push(targetRow);
            stats.keywords++;

            return rows;
        }

        // Escape CSV value
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        // Download CSV
        function downloadCSV() {
            const blob = new Blob([generatedCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'amazon_bulk_sheet_' + new Date().toISOString().slice(0,10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Generate input template
        function generateTemplate() {
            const wb = XLSX.utils.book_new();

            // Products sheet
            const productsData = [
                ['SKU', 'ASIN', 'Budget'],
                ['EXAMPLE-SKU-001', 'B0XXXXXXXXX', 100],
                ['EXAMPLE-SKU-002', 'B0YYYYYYYYY', 150]
            ];
            const productsSheet = XLSX.utils.aoa_to_sheet(productsData);
            XLSX.utils.book_append_sheet(wb, productsSheet, 'Products');

            // Keywords sheet
            const keywordsData = [
                ['Branded Keywords', 'Branded ASINs', 'Competitor Keywords', 'Competitor ASINs', 'Unbranded', 'Auto'],
                ['your brand keyword 1', 'B0AAAAAAAA', 'competitor keyword 1', 'B0CCCCCCCC', 'generic keyword 1', 'Close Match'],
                ['your brand keyword 2', 'B0BBBBBBBB', 'competitor keyword 2', 'B0DDDDDDDD', 'generic keyword 2', 'Loose Match'],
                ['', '', '', '', 'generic keyword 3', 'Complements'],
                ['', '', '', '', '', 'Substitutes']
            ];
            const keywordsSheet = XLSX.utils.aoa_to_sheet(keywordsData);
            XLSX.utils.book_append_sheet(wb, keywordsSheet, 'Keywords');

            // Download
            XLSX.writeFile(wb, 'bulk_sheet_input_template.xlsx');
        }
    </script>
</body>
</html>
